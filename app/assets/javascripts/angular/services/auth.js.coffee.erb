<% environment.context_class.instance_eval { include ActionView::Helpers } %>
<% environment.context_class.instance_eval { include AngularHostHelper } %>

App.factory 'AuthToken', ['$resource', ($resource) ->
  get: ->
    return {email: '', auth_token: ''} if not @_get()
    $.parseJSON(@_get())
  set: (authToken) ->
    localStorage.setItem('authToken', authToken)
  remove: ->
    localStorage.removeItem('authToken')
  addAuthTokenToJSONRequest: (obj) ->
    return obj if not @_get()
    authToken = @get()
    obj.email = authToken.email
    obj.auth_token = authToken.auth_token
    obj
  _get: ->
    localStorage.getItem('authToken')
]

App.factory 'AuthSessionStatus', [ ->
  _watches: []
  notifySessionExpired: ->
    watch.sessionExpired() for watch in @_watches
  watch: (fn) ->
    @_watches.push fn
]

App.factory 'AuthHttpInterceptor', ['$q', '$window', '$rootScope', 'AuthSessionStatus', ($q, $window, $rootScope, AuthSessionStatus) ->
  (promise) ->
    promise.then((response) ->
      response
    , (response) ->
      AuthSessionStatus.notifySessionExpired() if response.status == 401
      $q.reject(response)
    )
]

App.factory 'Auth', ['$http', '$location', 'AuthToken', 'AuthSessionStatus', ($http, $location, AuthToken, AuthSessionStatus) ->
  service =
    _isLoggedIn: AuthToken.get()?.email?.length
    _watches: []
    isLoggedIn: -> @_isLoggedIn
    login: (credentials) ->
      self = @
      $http.post(
        '<%= angularApiPath('/api/auth/login') %>',
        credentials
      ).success((data, status, headers, config) ->
        data.email = credentials.email
        AuthToken.set(JSON.stringify(data))

        self._isLoggedIn = true
        self._notifyWatches()
      ).error((data, status, headers, config) ->
        # TODO: Find a better way to display login failiure
        alert('Login Failed')
      )
    checkLogin: () ->
      if !@isLoggedIn()
        $location.url('/auth/login')
    logout: ->
      self = @
      $http.get(
        '<%= angularApiPath('/api/auth/logout') %>',
        AuthToken.addAuthTokenToJSONRequest({}),
      ).success((data, status, headers, config) ->
        AuthToken.remove()

        self._isLoggedIn = false
        self._notifyWatches()
      )
    watch: (fn) ->
      @_watches.push fn
    wrapActions: (resource, actions) ->
      actions = actions || ["query", "get", "update"]

      authTokenWrapper = (resource, action) ->
        authToken = AuthToken.get()

        resource["_" + action] = resource[action]

        resource[action] = (data, success, error) ->
          resource["_" + action] angular.extend({}, data or {},
            email: AuthToken.get().email
            auth_token: AuthToken.get().auth_token
          ), success, error

      wrappedResource = resource
      authTokenWrapper(wrappedResource, action) for action in actions
      wrappedResource
    sessionExpired: ->
      if @_isLoggedIn
        @_isLoggedIn = false
        @_notifyWatches()
    _notifyWatches: ->
      watch(@_isLoggedIn) for watch in @_watches

  AuthSessionStatus.watch(service)

  service
]
